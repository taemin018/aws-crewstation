<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.crewstation.mapper.purchase.PurchaseMapper">
    <sql id="giftSearch">
        <if test="search.keyword != null and search.keyword != ''">
            and (
            vpp.purchase_country like '%' || #{search.keyword} || '%'
            or vpp.post_title like '%' || #{search.keyword} || '%'
            )
        </if>
    </sql>

    <sql id="purchaseSearch">
        <if test="search.keyword != null and search.keyword != ''">
            AND (
            vpp.post_title LIKE CONCAT('%', #{search.keyword}, '%')
            OR vpp.purchase_country LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>
    </sql>

    <select id="selectAllByKeyWord">
        select vpp.id as post_id,
        vpp.post_title,
        vpp.purchase_country,
        vpp.purchase_delivery_method,
        vpp.purchase_limit_time,
        vpp.purchase_product_count,
        vpp.purchase_product_price as price,
        vpp.purchase_delivery_method,
        vpp.created_datetime,
        vpp.updated_datetime,
        vfps.file_path,
        vfps.file_name,
        tm.member_name,
        tm.chemistry_score
        from tbl_member tm join
        view_post_purchase vpp on tm.id = vpp.member_id
        join tbl_post_section tps on vpp.id = tps.post_id and vpp.post_status = 'active'
        join view_file_post_section_file vfps on tps.id = vfps.post_section_id and vfps.image_type = 'main'
        where vpp.created_datetime + (vpp.purchase_limit_time || 'hour')::interval > now()
        <include refid="giftSearch"/>
        limit #{criteria.count} offset #{criteria.offset}
    </select>

    <select id="selectCountAllByKeyWord">
        select count(vpp.id)
        from view_post_purchase vpp
        join tbl_post_section tps on vpp.id = tps.post_id and vpp.post_status = 'active'
        join view_file_post_section_file vfps on tps.id = vfps.post_section_id and vfps.image_type = 'main'
        where vpp.created_datetime + (vpp.purchase_limit_time || 'hour')::interval > now()
        <include refid="giftSearch"/>
    </select>

    <select id="selectByPostId">
        select vpp.id as post_id,
            vpp.post_title,
               vpp.purchase_country,
               vpp.purchase_delivery_method,
               vpp.purchase_limit_time,
               vpp.purchase_product_count,
               vpp.purchase_product_price as price,
               vpp.purchase_delivery_method,
               vpp.created_datetime,
               vpp.updated_datetime,
               tm.id as member_id,
               tm.chemistry_score,
               tm.member_name,
               tm.social_img_url,
               vfmf.id as file_id,
               vfmf.file_name,
               vfmf.file_origin_name,
               vfmf.file_path,
               ta.address
        from tbl_member tm
                 left outer join view_file_member_file vfmf on tm.id = vfmf.member_id
                 join view_post_purchase vpp on tm.id = vpp.member_id and vpp.id = #{postId}
                 join tbl_address ta on tm.id = ta.member_id
        where vpp.post_status = 'active' and vpp.created_datetime + (vpp.purchase_limit_time || 'hour')::interval > now()
    </select>

    <update id="updateReadCount">
        update tbl_post
        set post_read_count = post_read_count + 1
        where id = #{postId}
    </update>

    <insert id="insert">
        insert into tbl_purchase(post_id, purchase_product_price, purchase_limit_time, purchase_product_count,
                                 purchase_country, purchase_delivery_method)
        values (#{postId},#{purchaseProductPrice},#{purchaseLimitTime},#{purchaseProductCount},#{purchaseCountry},#{deliveryMethod})
    </insert>

    <update id="update">
        update tbl_purchase
        set purchase_country         = #{purchaseCountry},
            purchase_delivery_method = #{deliveryMethod},
            purchase_limit_time      = #{purchaseLimitTime},
            purchase_product_price   = #{purchaseProductPrice},
            purchase_product_count   = #{purchaseProductCount}
        where post_id = #{postId}
    </update>

    <select id="selectPurchaseDetailByPostId">
        SELECT vpp.id AS post_id,
               vpp.post_title,
               vpp.purchase_country,
               vpp.purchase_delivery_method,
               vpp.purchase_product_price AS price,
               vpp.created_datetime,
               vpp.updated_datetime,
               tm.id AS member_id,
               tm.member_name
        FROM tbl_member tm
        JOIN view_post_purchase vpp
        ON tm.id = vpp.member_id
        AND vpp.id = #{postId}
        WHERE vpp.post_status = 'active'
    </select>

    <!-- 멤버아이디로 구매내역 목록 조회 -->
    <select id="selectPurchaseList">
        SELECT
        tps.id AS payment_status_id,
        vpp.id AS post_id,
        vpp.post_title,
        vpp.purchase_product_price,
        tps.payment_phase AS status,
        tps.member_id AS member_id,
        tps.created_datetime,
        vfps.file_path
        FROM tbl_payment_status tps
        JOIN view_post_purchase vpp
        ON tps.purchase_id = vpp.id
        LEFT JOIN (
        SELECT tps.post_id, MIN(vf.file_path) AS file_path
        FROM tbl_post_section tps
        JOIN view_file_post_section_file vf
        ON tps.id = vf.post_section_id
        GROUP BY tps.post_id
        ) vfps ON vpp.id = vfps.post_id
        WHERE tps.member_id = #{memberId}
        AND vpp.post_status = 'active'
        <include refid="purchaseSearch"/>
        ORDER BY tps.created_datetime DESC
        LIMIT #{criteria.size}
        OFFSET #{criteria.offset}
    </select>


    <!-- 회원 주문 상세 조회 -->
    <select id="selectMemberOrderDetails">
        SELECT
            buyer.id                    AS buyer_member_id,
            buyer.member_name           AS member_name,
            buyer.member_phone          AS member_phone,
            addr.address_zip_code       AS address_zip_code,
            addr.address                AS address,
            addr.address_detail         AS address_detail,
            ps.id                       AS payment_status_id,
            ps.payment_phase            AS payment_phase,
            ps.created_datetime         AS created_datetime,
            ps.updated_datetime         AS updated_datetime,
            p.id                        AS post_id,
            p.post_title                AS post_title,
            pu.post_id                  AS purchase_id,
            pu.purchase_product_price   AS purchase_product_price,
            pu.purchase_country         AS purchase_country,
            pu.purchase_delivery_method AS purchase_delivery_method,
            seller.id                   AS seller_id,
            seller.member_name          AS seller_name,
            seller.member_phone         AS seller_phone,
            (
                SELECT f2.file_path
                FROM tbl_post_section s2
                         JOIN tbl_post_section_file sf2 ON s2.id = sf2.post_section_id
                         JOIN tbl_file f2 ON sf2.file_id = f2.id
                WHERE s2.post_id = p.id
                  AND sf2.image_type = 'main'
                LIMIT 1
            ) AS main_image
        FROM tbl_purchase pu
                 JOIN tbl_payment_status ps
                      ON ps.purchase_id = pu.post_id
                 JOIN tbl_member buyer
                      ON ps.member_id = buyer.id
                 LEFT JOIN tbl_address addr
                           ON buyer.id = addr.member_id
                 JOIN tbl_post p
                      ON pu.post_id = p.id
                 JOIN tbl_member seller
                      ON p.member_id = seller.id
        WHERE ps.id = #{paymentStatusId}
    </select>



    <!-- 전체 개수 조회 (페이징용) -->
    <select id="selectTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM view_post_purchase vpp
        JOIN tbl_member tm ON tm.id = vpp.member_id
        WHERE tm.id = #{memberId}
        AND vpp.post_status = 'active'
        <include refid="purchaseSearch"/>
    </select>

    <update id="updatePurchaseProductCount">
        update tbl_purchase
        set purchase_product_count = purchase_product_count + #{count}
        where post_id = #{postId} and purchase_product_count > 0
    </update>

    <select id="selectPurchaseProductCount">
        select purchase_product_count
        from tbl_purchase
        where post_id = #{postId}
    </select>
</mapper>